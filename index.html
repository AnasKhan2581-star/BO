<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Breakout Setup Scanner</title>
  <style>
    body {
      background: #181A20;
      color: #EFEFEF;
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    h1 { font-size: 2em; margin: 0 0 0.5em 0; }
    .container { max-width: 1100px; margin: auto; padding: 16px; }
    .section { background: #23272F; padding: 18px; margin-bottom: 20px; border-radius: 10px; }
    label, select, button {
      font-size: 1em;
      margin-top: 8px;
      background: none;
      border: none;
      color: inherit;
    }
    button {
      background: #FCD535;
      color: #23272F;
      font-weight: bold;
      border-radius: 6px;
      padding: 7px 20px;
      margin-left: 10px;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover { background: #ffd966; }
    .status { margin: 1em 0; font-size: 1.1em; }
    .table-wrap { overflow-x: auto; }
    table {
      width: 100%;
      min-width: 700px;
      border-collapse: collapse;
      margin-top: 1em;
      background: #181A20;
    }
    th, td {
      border: 1px solid #373737;
      padding: 7px 8px;
      text-align: center;
      font-size: 0.97em;
    }
    th { background: #23272F; }
    tr.success { background: #143b15; }
    tr.fail { background: #231813; }
    .mobile-hide { display: table-cell; }
    @media (max-width:700px) {
      .container { padding: 6px; }
      table, thead, tbody, th, td, tr { display: block; width: 100%; }
      th { display: none; }
      .mobile-hide { display: none; }
      td { border: none; border-bottom: 1px solid #2c2c2c; position: relative; padding-left: 48%; }
      td:before {
        position: absolute; left: 8px; top: 6px; font-weight: bold;
        color: #888;
        content: attr(data-label);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Breakout Setup Provider</h1>
    <!-- ETH Section -->
    <div class="section" id="eth-section">
      <h2>ETH Live Breakout Monitoring</h2>
      <form id="eth-form">
        <label>Timeframe: 
          <select id="eth-timeframe">
            <option value="1m">1m</option>
            <option value="5m">5m</option>
            <option value="15m" selected>15m</option>
            <option value="1h">1h</option>
            <option value="4h">4h</option>
            <option value="1d">1D</option>
          </select>
        </label>
        <button type="button" onclick="startETHMonitor()">Start</button>
      </form>
      <div class="status" id="eth-status"></div>
      <div id="eth-setup"></div>
    </div>
    <!-- Scanner Section -->
    <div class="section" id="scanner-section">
      <h2>Scanner: Top 150 (by volume) Breakout Setups</h2>
      <form id="scanner-form">
        <label>Scan Timeframe: 
          <select id="scan-timeframe">
            <option value="1m">1m</option>
            <option value="5m">5m</option>
            <option value="15m" selected>15m</option>
            <option value="1h">1h</option>
            <option value="4h">4h</option>
          </select>
        </label>
        <button type="button" onclick="scanMarket()">Scan</button>
      </form>
      <div class="status" id="scan-status"></div>
      <div class="table-wrap"><table id="results-table"></table></div>
    </div>
  </div>
  <script>
    const ETHSYMBOL = "ethusdt";
    let ethWS = null, ethKlines = [];
    let notificationSupported = ("Notification" in window);

    // --------------- Technical Indicator Functions ---------------

    // Utils
    function sma(data, len) {
      if (data.length < len) return null;
      return data.slice(-len).reduce((a,b)=>a+b,0) / len;
    }
    function ema(data, len) {
      if (data.length < len) return null;
      let k = 2/(len+1), ema = data[0];
      for(let i=1; i<data.length; ++i)
        ema = data[i]*k + ema*(1-k);
      return ema;
    }
    function rsi(closes, len=14) {
      if (closes.length < len+1) return null;
      let gains=0, losses=0;
      for(let i=1; i<=len; i++) {
        let diff = closes[closes.length-i] - closes[closes.length-i-1];
        if (diff > 0) gains += diff;
        else losses -= diff;
      }
      const rs = gains/(losses || 1e-9);
      return 100 - (100/(1+rs));
    }
    // StochRSI
    function stochRsi(closes, len=14) {
      if (closes.length<len+1) return null;
      let rsiArr=[];
      for(let i=0;i<=closes.length-len-1;i++)
        rsiArr.push(rsi(closes.slice(i,i+len+1), len));
      const lastRSI = rsiArr[rsiArr.length-1];
      if (!lastRSI) return null;
      const lowest = Math.min(...rsiArr);
      const highest = Math.max(...rsiArr);
      return ((lastRSI-lowest)/((highest-lowest)||1e-9))*100;
    }
    // MACD
    function macd(closes, fast=12, slow=26, signal=9) {
      if(closes.length<slow+signal) return {};
      let fastEma=[];
      for(let i=0;i<closes.length;i++)
        fastEma.push(ema(closes.slice(0,i+1),fast));
      let slowEma=[];
      for(let i=0;i<closes.length;i++)
        slowEma.push(ema(closes.slice(0,i+1),slow));
      let macdArr = fastEma.map((v,i)=>v-slowEma[i]);
      let signalArr=[];
      for(let i=0;i<macdArr.length;i++)
        signalArr.push(ema(macdArr.slice(0,i+1),signal));
      return {
        macd: macdArr[macdArr.length-1],
        signal: signalArr[signalArr.length-1]
      };
    }
    // ATR (Average True Range)
    function atr(klines, len=14){
      if (klines.length<len+1) return null;
      let trs=[];
      for(let i=1;i<klines.length;i++){
        let h = klines[i][2], l = klines[i][3], c_prev = klines[i-1][4];
        trs.push(Math.max(h-l, Math.abs(h-c_prev), Math.abs(l-c_prev)));
      }
      return sma(trs, len);
    }

    // --------------- ETH Klines Monitoring (Live) ---------------
    function startETHMonitor() {
      const tf = document.getElementById('eth-timeframe').value;
      let interval = tf;
      document.getElementById('eth-status').innerText = 'Connecting...';
      // Close previous WS if open
      if (ethWS) ethWS.close();
      ethKlines = [];

      // Open new WebSocket (Binance public API)
      ethWS = new WebSocket(`wss://fstream.binance.com/ws/${ETHSYMBOL}@kline_${interval}`);
      ethWS.onopen = () => {
        document.getElementById('eth-status').innerHTML = "Live <b>ETH/USDT</b> klines loaded.";
      };
      ethWS.onclose = () => {
        document.getElementById('eth-status').innerText = "Disconnected.";
      };
      ethWS.onerror = () => {
        document.getElementById('eth-status').innerText = "WebSocket error!";
      };
      ethWS.onmessage = (msg) => {
        const data = JSON.parse(msg.data);
        const k = data.k;
        if(!k.x) return; // Only process closed klines
        let candle = [
          Number(k.t), Number(k.o), Number(k.h),
          Number(k.l), Number(k.c), Number(k.v)
        ];
        ethKlines.push(candle);
        if(ethKlines.length>100) ethKlines.shift();

        // --- Run breakout detection for last 15 closed candles
        detectETHBreakout();
      };
    }

    function detectETHBreakout() {
      const n = 15;
      if (ethKlines.length < n+2) return;
      // Extract closes, highs, lows, volumes
      const closes = ethKlines.map(k=>k[4]);
      const vols = ethKlines.map(k=>k[5]);
      // 1. Downtrend & now recovery (last couple of closes > previous)
      let wasDowntrend = closes.slice(-n-2,-2).every((v,i,a)=>v<a[i+1]);
      let nowRecovery = closes[closes.length-1] > closes[closes.length-2];
      // 2. 1.2x avg volume breakout on last candle
      let avgVol = sma(vols.slice(-n-1,-1), n);
      let lastVol = vols[vols.length-1];
      let vRatio = lastVol/avgVol;
      // 3. Show info and trigger notification
      let msg = `Avg Vol (15): ${avgVol.toFixed(2)}<br>
                 Last Vol: ${lastVol.toFixed(2)} (<b>${vRatio.toFixed(2)}x</b>)<br>
                 Downtrend: <b>${wasDowntrend?'YES':'NO'}</b>,
                 Recovery: <b>${nowRecovery?'YES':'NO'}</b><br>`;
      let signal = '';
      if (wasDowntrend && nowRecovery && vRatio>1.2) {
        signal = '<span style="color:#56d456;font-weight:bold">Breakout Setup Detected! ðŸš€</span>';
        showNotification("ETH/USDT BREAKOUT!", `Breakout on ETH/USDT!\nVol: ${vRatio.toFixed(2)}x`);
      }
      document.getElementById('eth-setup').innerHTML = msg + signal;
    }

    function showNotification(title, body) {
      if (!notificationSupported) return;
      if (Notification.permission==='granted') {
        new Notification(title, {body});
      } else if (Notification.permission==='default') {
        Notification.requestPermission().then(p=>{
          if (p==='granted') new Notification(title, {body});
        });
      }
    }

    // ========== Scanner for Top 150 Coins ==========
    async function scanMarket() {
      const tf = document.getElementById('scan-timeframe').value;
      document.getElementById('scan-status').innerText = "Fetching symbols...";
      document.getElementById('results-table').innerHTML = '';
      let symbols = [];
      // 1. Fetch top 150 by volume from Binance
      try {
        // CORS warning: this may not work directly!
        let resp = await fetch('https://api.binance.com/api/v3/ticker/24hr');
        let data = await resp.json();
        data = data.filter(t=>t.symbol.endsWith("USDT"));
        data.sort((a,b)=>parseFloat(b.quoteVolume)-parseFloat(a.quoteVolume));
        symbols = data.slice(0,150).map(t=>t.symbol.toLowerCase());
      } catch(e) {
        document.getElementById('scan-status').innerHTML = "API error! Try with CORS proxy or backend. Showing demo results.<br>"+e;
        showScannerDemo();
        return;
      }
      document.getElementById('scan-status').innerText = 'Scanning...';

      // 2. Fetch klines for each symbol (limit 30)
      let tf_map = { "1m":"1m", "5m":"5m", "15m":"15m", "1h":"1h", "4h":"4h"};
      let results = [];
      for (let i=0;i<symbols.length;i++) {
        let s = symbols[i];
        try {
          let kUrl = `https://api.binance.com/api/v3/klines?symbol=${s.toUpperCase()}&interval=${tf_map[tf]}&limit=30`;
          let kres = await fetch(kUrl); // CORS WARNING
          let kdata = await kres.json();
          // Convert [openTime,open,high,low,close,vol,...] to numbers
          let klines = kdata.map(k=>[Number(k[0]),...k.slice(1,6).map(Number)]);
          // Run detection
          let res = analyzeSymbol(s, klines);
          if (res) results.push(res);
        } catch (e){/*skip symbol on error*/}
        if(i%20===0) { document.getElementById('scan-status').innerText = `Scanning: ${i+1}/${symbols.length}`;}
      }

      // 3. Show results
      renderTable(results);
      document.getElementById('scan-status').innerHTML = `<b>Done:</b> ${results.length} setups detected.<br>
        <span style="color:#f55;font-size:90%">Note: May need CORS proxy to fetch Binance REST APIs.</span>`;
    }

    // Analyze a symbol's klines for breakout and trade suggestion
    function analyzeSymbol(symbol, klines) {
      // Must have at least 17 klines
      if (klines.length<17) return null;
      let closes = klines.map(k=>k[4]);
      let highs = klines.map(k=>k[2]);
      let lows = klines.map(k=>k[3]);
      let vols = klines.map(k=>k[5]);
      // Downtrend? (majority closes down over 10 bars, or series of lowers)
      let n = 13, last_n = closes.slice(-n-2,-2), isDown = last_n.every((v,i,a)=>v<=a[i+1]);
      // Retrace detected? (last 2 closes > prev 2)
      let retrace = closes.at(-1) > closes.at(-2) && closes.at(-2)>closes.at(-3);
      // Resistance range: flat resistance
      let resistance = Math.max(...highs.slice(-6,-2));
      let attemptingBreak = closes.at(-1) > resistance*0.998; // Near resistance
      // Volume spike
      let avgVol = sma(vols.slice(-15,-1), 15);
      let lastVol = vols.at(-1);
      let volRatio = lastVol/avgVol;
      // StochRSI < 30
      let stochrsiVal = stochRsi(closes, 14);
      // RSI bullish divergence: last close > prev, RSI turns up
      let rsiNow = rsi(closes);
      let rsiPrev = rsi(closes.slice(0,-1));
      let bullishDiv = closes.at(-1)>closes.at(-2)&&rsiNow>rsiPrev&&rsiNow<50;
      // MACD bullish signal
      let macdObj = macd(closes);
      let macdBull = (macdObj.macd > macdObj.signal && macdObj.macd<0);
      let conds = [
        isDown, retrace, attemptingBreak, volRatio>1.2, stochrsiVal<30, bullishDiv, macdBull
      ];
      if(conds.every(Boolean)){
        // Calculate entry, stop, TP as per 1.5x ATR
        let entry = closes.at(-1);
        let mATR = atr(klines, 14) || (highs.at(-1)-lows.at(-1));
        let stop = entry-(1.5*mATR);
        let takeP = entry+mATR*2.2;
        return {
          symbol: symbol.toUpperCase(),
          entry:entry.toFixed(4), stop:stop.toFixed(4), takeP:takeP.toFixed(4),
          volRatio:volRatio.toFixed(2), stochrsi:stochrsiVal?.toFixed(1), 
          rsi:rsiNow?.toFixed(1), macd:macdObj.macd?.toFixed(4), signal:macdObj.signal?.toFixed(4)
        };
      }
      return null;
    }

    function renderTable(results){
      let th = `<tr>
        <th>Symbol</th><th>Entry</th><th>Stop</th><th>Take Profit</th>
        <th>Volume xAvg</th><th>StochRSI</th><th>RSI</th>
        <th>MACD</th><th>Signal</th>
      </tr>`;
      let rows = results.map(r=>`
        <tr class="success">
         <td>${r.symbol}</td>
         <td>${r.entry}</td>
         <td>${r.stop}</td>
         <td>${r.takeP}</td>
         <td>${r.volRatio}</td>
         <td>${r.stochrsi}</td>
         <td>${r.rsi}</td>
         <td>${r.macd}</td>
         <td>${r.signal}</td>
        </tr>
      `).join('');
      document.getElementById('results-table').innerHTML = th+rows;
    }

    // Demo fallback for result table when CORS kicks in
    function showScannerDemo() {
      let ex = [{
        symbol:'BTCUSDT', entry:'41955.20', stop:'41000.00', takeP:'43291.20',
        volRatio:'1.37', stochrsi:'19.7', rsi:'34.2', macd:'-28.1999', signal:'-31.6851'
      },{
        symbol:'OPUSDT', entry:'2.4040', stop:'2.2920', takeP:'2.6660',
        volRatio:'1.30', stochrsi:'17.2', rsi:'32.2', macd:'-0.0712', signal:'-0.0881'
      }];
      renderTable(ex);
    }

    // Get permission for notification on page load
    if(notificationSupported && Notification.permission==='default'){
      Notification.requestPermission();
    }
  </script>
</body>
</html>

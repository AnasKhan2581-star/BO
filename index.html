<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>üöÄ Smart Crypto Breakout Scanner</title>
<style>
 :root{--bg:#0c0c0c;--panel:#161616;--accent:#00ffae;--warn:#ffce00;
       --pass:#16c784;--fail:#ff4957;--text:#e6e6e6;--border:#333;}
 *{box-sizing:border-box;margin:0;padding:0;font-family:Arial,Helvetica,sans-serif}
 body{background:var(--bg);color:var(--text);padding:12px}
 h1,h3{text-align:center}h1{color:var(--accent);font-size:5vw;margin:15px 0}
 select,input,button{background:var(--panel);color:var(--text);border:1px solid var(--border);
   padding:10px;border-radius:8px;font-size:1.05em;width:225px}
 button:hover{background:#222;cursor:pointer}
 .container{max-width:1100px;margin:auto}
 .controls,.stats,.analysis-section{margin:18px 0;text-align:center}
 .trade-box{background:var(--panel);border-radius:10px;padding:16px;margin:24px auto;
   max-width:750px;box-shadow:0 0 14px #0007}
 .trade-box h2{color:var(--accent);margin-bottom:8px;font-size:1.32em}
 .trade-box table{width:100%;border-collapse:collapse;margin-top:10px;font-size:.92em}
 .trade-box th,.trade-box td{padding:7px 10px;border-bottom:1px solid var(--border);text-align:left}
 .trade-box th{color:var(--warn)}
 .pass{color:var(--pass);font-weight:700}.fail{color:var(--fail);font-weight:700}
 .log-box{background:#111;border:1px solid #0a0;border-radius:8px;color:#0f0;font-family:monospace;
          padding:10px;max-height:190px;overflow-y:auto}
</style>
</head>
<body>
<div class="container">
  <h1>üöÄ Smart Crypto Breakout Scanner</h1>

  <div class="controls">
    <label>Timeframe:</label><br>
    <select id="timeframe">
      <option value="15m">15 m</option><option value="30m">30 m</option>
      <option value="1h" selected>1 h</option><option value="4h">4 h</option>
      <option value="1d">1 d</option></select><br>
    <label>Account Size ($):</label><br>
    <input id="accountSize" type="number" min="100" step="100" value="1000"><br>
    <label>Risk / Trade (%):</label><br>
    <input id="riskPerTrade" type="number" min="0.1" max="5" step="0.1" value="1"><br>
    <label>Min R:R:</label><br>
    <input id="minRR" type="number" min="1" max="10" step="0.1" value="2"><br>
    <label>Min Target %:</label><br>
    <input id="minTargetPercent" type="number" min="4" max="20" step="0.1" value="5"><br>
    <label>Volume Multiplier √ó:</label><br>
    <input id="volumeMultiplier" type="number" min="1" max="5" step="0.1" value="1.2"><br>
    <button id="scanButton">üîç Start Scan</button>
  </div>

  <div class="stats">
    <span>Coins: <b id="coinsScanned">0</b></span> | 
    <span>Qualified: <b id="qualifiedSetups">0</b></span> | 
    <span>Avg R:R <b id="avgRR">0.0</b></span> | 
    <span>Avg Target <b id="avgTarget">0.0%</b></span>
  </div>

  <div class="analysis-section">
    <h3>üî¨ Single-Coin Analysis</h3>
    <input id="individualCoinInput" placeholder="BTCUSDT" style="width:260px">
    <button id="analyzeCoinButton">Analyse</button>
    <div id="individualAnalysisResult" style="margin-top:22px"></div>
  </div>

  <div id="scanResults" style="margin-top:34px"></div>
  <div class="log-box" id="logBox">Ready to scan top 150 coins‚Ä¶</div>
</div>

<script>
/* ----------  Utility functions ---------- */
const API="https://api.binance.com";
const sleep=ms=>new Promise(r=>setTimeout(r,ms));
const avg=a=>a.reduce((s,v)=>s+v,0)/a.length||0;
const log=m=>{const box=document.getElementById("logBox");box.textContent+=`\n${new Date().toLocaleTimeString()} ${m}`;box.scrollTop=box.scrollHeight};

/* ----------  Indicator helpers ---------- */
const ema=(arr,n)=>{if(arr.length<n)return[];const k=2/(n+1);let e=[avg(arr.slice(0,n))];for(let i=n;i<arr.length;i++)e.push(arr[i]*k+e[i-n]*(1-k));return e};
const macd=(c)=>{const fast=ema(c,12),slow=ema(c,26);if(!slow.length)return{macd:[],sig:[]};
 const m=fast.slice(-slow.length).map((v,i)=>v-slow[i]);return{macd:m,sig:ema(m,9)}};
const rsi=(c,p=14)=>{if(c.length<p+1)return[];let g=[],l=[];for(let i=1;i<c.length;i++){const d=c[i]-c[i-1];g.push(d>0?d:0);l.push(d<0?-d:0)}
 let out=[];for(let i=p-1;i<g.length;i++){const ag=avg(g.slice(i-p+1,i+1)),al=avg(l.slice(i-p+1,i+1));out.push(al===0?100:100-100/(1+ag/al))}return out};
const bollExp=(c)=>{const p=20;if(c.length<p+2)return false;const slice=c.slice(-p-2);
 const sma=avg(slice.slice(0,p)),var1=avg(slice.slice(0,p).map(x=>(x-sma)**2)),s1=Math.sqrt(var1);
 const sma2=avg(slice.slice(1,p+1)),var2=avg(slice.slice(1,p+1).map(x=>(x-sma2)**2)),s2=Math.sqrt(var2);
 return (s2-s1)/s1>0.15; // 15 % band expansion
};

/* ----------  Binance fetch helpers ---------- */
const topCoins=async()=>{
  const data=await fetch(`${API}/api/v3/ticker/24hr`).then(r=>r.json()).catch(()=>[]);
  return data.filter(x=>x.symbol.endsWith("USDT")&&!/UP|DOWN|BULL|BEAR/.test(x.symbol))
             .sort((a,b)=>+b.quoteVolume-+a.quoteVolume).slice(0,150);
};
const candles=async(s,i,l=400)=>{
  const data=await fetch(`${API}/api/v3/klines?symbol=${s}&interval=${i}&limit=${l}`).then(r=>r.json()).catch(()=>null);
  return data?data.map(d=>({o:+d[1],h:+d[2],l:+d[3],c:+d[4],v:+d[5],t:d[0]})):null;
};

/* ----------  Core analysis ---------- */
async function analyse(sym,intv,opt){
  try{
    const cs=await candles(sym,intv);if(!cs||cs.length<80)return{error:"insufficient data"};
    const closes=cs.map(x=>x.c),vols=cs.map(x=>x.v);
    const last=cs.at(-2);           // last COMPLETED candle
    const cur =cs.at(-1);           // current candle (still forming)
    const avgVol=avg(vols.slice(-31,-1));  // 30-candle average, excl. current
    const volOK=last.v>=avgVol*opt.volMult;

    /* === Trend-leg detection via EMA 10/40 === */
    const ema10=ema(closes,10),ema40=ema(closes,40);
    if(!ema40.length)return{error:"ema"};
    const inDown=ema10.slice(-ema40.length).map((v,i)=>v<ema40[i]);
    // find longest recent continuous downleg >=12 bars, then up-leg >=6
    let downEnd=-1;for(let i=inDown.length-1;i>=0;i--)if(!inDown[i]){downEnd=i;break;}
    let downStart=downEnd;while(downStart>0&&inDown[downStart-1])downStart--;
    const downLen=downEnd-downStart+1;
    let upStart=downEnd+1,upEnd=upStart;while(upEnd<inDown.length&& !inDown[upEnd])upEnd++;const upLen=upEnd-upStart;
    const structureOK=downLen>=12 && upLen>=6;

    /* === Resistance range from revival leg === */
    const revival=cs.slice(-(upLen+1),-1);
    const resHi=Math.max(...revival.map(x=>x.h));
    const resLo=Math.min(...revival.map(x=>x.h))*0.997; // tiny buffer
    const broke=resHi>0 && cur.c>resHi*1.003;           // breakout?

    /* === FVG targets ‚â• minTargetPct === */
    const fvg=[];for(let i=2;i<cs.length-2;i++){
      const prev=cs[i-1],next=cs[i+1];
      if(prev.h<next.l && next.l>cur.c){
        const pct=(next.l-cur.c)/cur.c*100;
        if(pct>=opt.minTargetPct)fvg.push({price:next.l,pct});
      }
    }
    const targets=fvg.sort((a,b)=>a.price-b.price).slice(0,3);

    /* === Indicator confirmations === */
    const rsis=rsi(closes);const lastR=rsis.at(-1)||50;const rsiOK=lastR>50;
    const mc=macd(closes);const macOK=mc.macd.at(-2)<mc.sig.at(-2)&&mc.macd.at(-1)>mc.sig.at(-1);
    const bbOK=bollExp(closes);
    const confirmCnt=[rsiOK,macOK,bbOK].filter(Boolean).length>=2;

    /* === ATR stop & RR === */
    const atr=avg(cs.slice(-14).map((c,i,a)=>i?Math.max(c.h-c.l,Math.abs(c.h-a[i-1].c),Math.abs(c.l-a[i-1].c)):0));
    const stop=cur.c-2.5*atr;
    const bestRR=targets.length?Math.max(...targets.map(t=>(t.price-cur.c)/(cur.c-stop))):0;

    /* === Criteria list === */
    const criteria=[
      {n:"Last-Candle Volume ‚â•1.2√óAvg",p:volOK,val:`${last.v.toLocaleString()} / ${avgVol.toLocaleString()}`},
      {n:"Down-leg ‚â•12 bars",p:downLen>=12,val:`${downLen} bars`},
      {n:"Revival ‚â•6 bars",p:upLen>=6,val:`${upLen} bars`},
      {n:"Breaks Resistance Range",p:broke,val:`>${resHi.toFixed(6)}`},
      {n:"FVG Targets ‚â•"+opt.minTargetPct+"%",p:targets.length>0,val:targets.length},
      {n:"‚â•2 Confirm Indicators",p:confirmCnt,val:`RSI ${rsiOK?'‚úÖ':'‚ùå'}, MACD ${macOK?'‚úÖ':'‚ùå'}, BB ${bbOK?'‚úÖ':'‚ùå'}`},
      {n:`Risk/Reward ‚â• ${opt.minRR}`,p:bestRR>=opt.minRR,val:bestRR.toFixed(2)}
    ];
    const passed=criteria.filter(x=>x.p).length;
    const qualified=volOK&&passed>=5; // volume must pass + ‚â•4 others

    return{
      sym,qualified,criteria,passed,need:5,
      price:cur.c,resHi,resLo,stop:stop.toFixed(6),rr:bestRR.toFixed(2),
      vol:last.v,avgVol,rsi:lastR.toFixed(1),targets
    };
  }catch(e){return{error:e.message}};
}

/* ----------  Rendering ---------- */
const row=c=>`<tr><td>${c.n}</td><td class="${c.p?'pass':'fail'}">${c.p?'‚úÖ':'‚ùå'} ${c.val}</td></tr>`;
function render(s,w){
  const tgt=s.targets.length?s.targets.map(t=>`${t.price.toFixed(6)} (${t.pct.toFixed(1)}%)`).join(" ‚Üí "):"No targets";
  w.innerHTML+=`<div class="trade-box">
   <h2>${s.qualified?'‚úÖ':'‚ùå'} <b>${s.sym}</b> ${s.qualified?'Qualified':'Not Qualified'}</h2>
   <table><tr><th>Key</th><th>Value</th></tr>
     <tr><td>Entry</td><td>${s.price.toFixed(6)}</td></tr>
     <tr><td>Resistance</td><td>${s.resLo.toFixed(6)}-${s.resHi.toFixed(6)}</td></tr>
     <tr><td>Stop-Loss</td><td>${s.stop}</td></tr>
     <tr><td>Targets</td><td>${tgt}</td></tr>
     <tr><td>Risk:Reward</td><td>${s.rr}</td></tr>
     <tr><td>Volume</td><td>${s.vol.toLocaleString()} / ${s.avgVol.toLocaleString()}</td></tr>
     <tr><td>RSI</td><td>${s.rsi}</td></tr>
   </table>
   <table><thead><tr><th>Criteria (${s.passed}/7)</th><th>Status</th></tr></thead>
     <tbody>${s.criteria.map(row).join("")}</tbody></table>
   <p style="text-align:center;font-weight:bold;color:${s.qualified?'var(--pass)':'var(--fail)'}">
    ${s.qualified?'‚úÖ SETUP MEETS REQUIREMENTS':'‚ùå DOES NOT MEET REQUIREMENTS'}</p></div>`;
}

/* ----------  Scan loop ---------- */
async function scan(){
  const opt={
    minRR:+document.getElementById("minRR").value||2,
    minTargetPct:+document.getElementById("minTargetPercent").value||5,
    volMult:+document.getElementById("volumeMultiplier").value||1.2
  };
  const tf=document.getElementById("timeframe").value,
        wrap=document.getElementById("scanResults"),
        btn=document.getElementById("scanButton");
  wrap.innerHTML="";btn.disabled=true;
  document.getElementById("coinsScanned").textContent="0";
  document.getElementById("qualifiedSetups").textContent="0";
  log("Fetching top 150 coins‚Ä¶");
  const coins=await topCoins();
  let setups=[],i=0;
  for(const c of coins){
    document.getElementById("coinsScanned").textContent=++i;
    log(`[${i}/${coins.length}] ${c.symbol}`);
    const res=await analyse(c.symbol,tf,opt);
    if(!res.error&&res.qualified){setups.push(res);document.getElementById("qualifiedSetups").textContent=setups.length}
    if(i%12===0)await sleep(900);
  }
  if(!setups.length)wrap.innerHTML="<p style='color:var(--fail);text-align:center'>No qualified setups.</p>";
  else{
    setups.sort((a,b)=>parseFloat(b.rr)-parseFloat(a.rr));
    document.getElementById("avgRR").textContent=avg(setups.map(x=>+x.rr)).toFixed(2);
    document.getElementById("avgTarget").textContent=
      (avg(setups.map(x=>x.targets[0]?x.targets[0].pct:0))).toFixed(1)+"%";
    setups.forEach(s=>render(s,wrap));
  }
  btn.disabled=false;
}

/* ----------  Single-coin analyse ---------- */
async function analyseOne(){
  const inp=document.getElementById("individualCoinInput").value.trim().toUpperCase();
  if(!inp)return;
  const sym=inp.endsWith("USDT")?inp:inp+"USDT";
  const tf=document.getElementById("timeframe").value;
  const opt={
    minRR:+document.getElementById("minRR").value||2,
    minTargetPct:+document.getElementById("minTargetPercent").value||5,
    volMult:+document.getElementById("volumeMultiplier").value||1.2
  };
  const out=document.getElementById("individualAnalysisResult");
  out.innerHTML=`<p>Analyzing ${sym}‚Ä¶</p>`;
  const res=await analyse(sym,tf,opt);
  out.innerHTML=res.error?`<p style='color:var(--fail)'>${res.error}</p>`:"";
  if(!res.error)render(res,out);
}

/* ----------  Event bindings ---------- */
document.getElementById("scanButton").onclick=scan;
document.getElementById("analyzeCoinButton").onclick=analyseOne;
log("Default volume-multiplier set to 1.2 √ó 30-bar average. Ready!");
</script>
</body>
</html>
